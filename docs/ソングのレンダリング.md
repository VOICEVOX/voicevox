# ソングのレンダリング

ソングのレンダリング（歌声合成APIの呼び出しなど）は、`RENDER`アクションと、そこで呼び出される`SongTrackRenderer.render()`で行われています。

## `songTrackRendering.ts`の主要なクラス・型の説明

### `SnapshotForRender`（スナップショット）

プロジェクト（トラック情報、プロジェクト設定など）のスナップショットです。
レンダリング処理中に元データが変更されることによる不整合を防ぐため、レンダリングの直前に作成して、そのスナップショットを基にレンダリングを行います。

### `PhraseForRender`（フレーズ）

レンダリングの単位で、ノーツや関連情報、およびレンダリングによって生成される中間・最終データを保持します。
ミュータブルなオブジェクトとして扱われ、レンダリング過程でプロパティが更新されていきます。
フレーズは、トラックのノーツを休符で区切ることによって生成されます。

### `SongTrackRenderer`（ソングトラックのレンダラー）

ソングトラックのレンダリング処理全体を管理する役割を担います。

主な機能は以下の通りです。

- **ソングトラックのレンダリングの実行**  
  ソングトラックのノーツを複数のフレーズに分割し、クエリ（音素タイミング）、歌唱ピッチ、歌唱ボリュームを順次生成した後、最終的な歌声を合成します。生成・合成はフレーズ単位で行い、再生ヘッドに近いフレーズから優先的に処理します。
- **キャッシュ活用**  
  生成されたクエリ、ピッチ、ボリューム、歌声をキャッシュし、再レンダリング時の処理を高速化します。
- **外部エンジン連携**  
  歌声合成エンジンと連携して、クエリ取得や歌声合成などを行います。
- **イベント通知**  
  レンダリングの各段階（フレーズ生成、キャッシュ適用、歌声データ生成完了、エラー発生など）でイベントを発行し、外部に通知します。
- **中断処理**  
  進行中のレンダリング処理を外部から中断できる機能を提供します。

## ソングのレンダリングの流れ

`SingingStore` の `RENDER` アクションが呼び出されると、以下の処理が実行されます。（[フローチャート](res/ソングのレンダリングのフローチャート.md)）

1. `songTrackRenderer`のインスタンスが存在するか確認します。
    - 存在しない場合は、`SETUP_SONG_TRACK_RENDERER` アクションを呼び出してインスタンスの生成とイベントリスナーの登録を行います。
2. レンダリングループが実行中かどうか確認します。
    - 実行中の場合は、再レンダリング（進行中のレンダリングの中断と、レンダリングの再スタート）を要求して、`RENDER` アクションを終了します。
    - 実行中でない場合は、レンダリングの開始を要求して、処理を続行します。
3. **レンダリングループを実行**  
    レンダリング開始（再スタート）の要求があり、かつレンダリング停止の要求がない限り、以下の処理を繰り返します。
    1. **プロジェクトスナップショットの作成 (`createSnapshot`)**  
        レンダリング処理中に変更される可能性のあるデータ（プロジェクト）のコピー（スナップショット）を作成します。
    2. **フレーズ生成 (`generatePhrases`)**  
        スナップショット内のノート情報を基に、レンダリングの基本単位となるフレーズ（`PhraseForRender`）を生成します。フレーズは、ノーツを休符で区切ることによって生成されます。
        この時点では、フレーズにはまだ音声データやその元となる詳細なパラメーターは含まれていません。
        完了したら、`PhrasesGeneratedEvent` イベントが発行されます。
    3. **レンダリング可能なフレーズを抽出（`filterRenderablePhrases`）**  
        生成された全フレーズの中から、実際にレンダリングが可能なもの（例：シンガーが割り当てられているトラックに属するフレーズ）を抽出します。
    4. **キャッシュ適用 (`applyCachedDataToPhrases`)**  
        レンダリング可能な各フレーズに対して、過去のレンダリング結果（クエリ、歌唱ピッチ、歌唱ボリューム、歌声）がキャッシュに存在するかどうかを確認し、存在すれば読み込んでフレーズに適用します。
        具体的には、以下の処理をフレーズごとに行います。
        1. **クエリのキャッシュを適用**
            - クエリのキャッシュが存在する場合は、読み込んでフレーズに適用します。
            - クエリのキャッシュが存在しない場合は、次のフレーズのキャッシュ読み込み処理に移ります。
        2. **歌唱ピッチのキャッシュを適用**
            - 歌唱ピッチのキャッシュが存在する場合は、読み込んでフレーズに適用します。
            - 歌唱ピッチのキャッシュが存在しない場合は、次のフレーズのキャッシュ読み込み処理に移ります。
        3. **歌唱ボリュームのキャッシュを適用**
            - 歌唱ボリュームのキャッシュが存在する場合は、読み込んでフレーズに適用します。
            - 歌唱ボリュームのキャッシュが存在しない場合は、次のフレーズのキャッシュ読み込み処理に移ります。
        4. **歌声のキャッシュを適用**
            - 歌声のキャッシュが存在する場合は、読み込んでフレーズに適用します。

        完了したら、`CacheLoadedEvent` が発行されます。
    5. **レンダリングが必要なフレーズを抽出（`filterPhrasesRequiringRender`）**  
        キャッシュを適用しても、まだクエリ、歌唱ピッチ、歌唱ボリューム、歌声のいずれかが不足しているフレーズが、実際にレンダリングが必要なフレーズとなります。それらを抽出します。
    6. **各フレーズをレンダリング**  
        未処理の（レンダリングされていない）フレーズが存在し、かつ中断要求がない限り、以下の処理を繰り返します。
        1. **レンダリングするフレーズの選択 (`selectPriorPhrase`)**  
            レンダリング待ちのフレーズ群の中から、現在の再生ヘッド位置に最も近いフレーズを次に処理する対象として選択します。
        2. **フレーズをレンダリング (`renderPhrase`)**  
            選択されたフレーズに対して、以下の処理を順次実行します。
            1. `PhraseRenderingStartedEvent` を発行します。
            2. **クエリ（音素タイミング）を生成**
                1. クエリが未生成の場合、エンジンAPI (`engineSongApi.fetchFrameAudioQuery`) を呼び出してクエリを生成します。
                2. 生成後、結果をキャッシュに保存し、フレーズに適用します。
                3. `QueryGenerationCompleteEvent` を発行します。
            3. **歌唱ピッチを生成**
                1. 歌唱ピッチが未生成の場合、エンジンAPI (`engineSongApi.fetchSingFrameF0`) を呼び出して歌唱ピッチを生成します。
                2. 生成後、結果をキャッシュに保存し、フレーズに適用します。
                3. `PitchGenerationCompleteEvent` を発行します。
            4. **歌唱ボリュームを生成**
                1. 歌唱ボリュームが未生成の場合、エンジンAPI (`engineSongApi.fetchSingFrameVolume`) を呼び出して歌唱ボリュームを生成します。
                2. 生成後、結果をキャッシュに保存し、フレーズに適用します。
                3. `VolumeGenerationCompleteEvent` を発行します。
            5. **歌声を合成**
                1. 歌声が未生成の場合、エンジンAPI (`engineSongApi.frameSynthesis`) を呼び出して歌声を合成します。
                2. 生成後、結果をキャッシュに保存し、フレーズに適用します。
                3. `VoiceSynthesisCompleteEvent` を発行します。
            6. フレーズのレンダリングが完了したら、`PhraseRenderingCompleteEvent` を発行します。
                フレーズのレンダリング中にエラーが発生した場合は、`PhraseRenderingErrorEvent` を発行して、次のフレーズの処理に進みます。
