<template>
  <q-separator class="bg-surface" v-if="menudata.type === 'separator'" />
  <q-item
    class="bg-background"
    v-else-if="menudata.type === 'root'"
    clickable
    dense
    :disable="menudata.disabled"
    :class="selected && 'active-menu'"
    @click="menudata.onClick"
  >
    <q-item-section side class="q-py-2" v-if="menudata.icon">
      <img :src="menudata.icon" class="engine-icon" />
    </q-item-section>

    <q-item-section>{{ menudata.label }}</q-item-section>
    <q-item-section
      side
      v-if="menudata.label != undefined && getMenuBarHotkey(menudata.label)"
    >
      {{ getMenuBarHotkey(menudata.label) }}
    </q-item-section>

    <q-item-section side>
      <q-icon name="keyboard_arrow_right" />
    </q-item-section>

    <q-menu
      anchor="top end"
      transition-show="none"
      transition-hide="none"
      v-model="selectedComputed"
      :target="!uiLocked"
    >
      <menu-item
        v-for="(menu, i) of menudata.subMenu"
        :key="i"
        :menudata="menu"
        v-model:selected="subMenuOpenFlags[i]"
        @mouseover="reassignSubMenuOpen(i)"
      />
    </q-menu>
  </q-item>
  <q-item
    v-else
    dense
    clickable
    v-ripple
    v-close-popup
    class="bg-background"
    :disable="menudata.disabled"
    @click="menudata.onClick"
  >
    <q-item-section
      avatar
      v-if="'icon' in menudata && menudata.icon != undefined"
    >
      <q-avatar>
        <img :src="menudata.icon" />
      </q-avatar>
    </q-item-section>

    <q-item-section>{{ menudata.label }}</q-item-section>
    <q-item-section
      side
      v-if="menudata.label != undefined && getMenuBarHotkey(menudata.label)"
    >
      {{ getMenuBarHotkey(menudata.label) }}
    </q-item-section>
  </q-item>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import type { MenuItemData } from "@/components/MenuBar.vue";
import { useStore } from "@/store";
import { HotkeyAction } from "@/type/preload";
const props = withDefaults(
  defineProps<{
    selected?: boolean;
    menudata: MenuItemData;
  }>(),
  {
    selected: false,
  }
);
const emit =
  defineEmits<{
    (e: "update:selected", val: boolean): void;
  }>();
const store = useStore();
const hotkeySettingsMap = computed(
  () =>
    new Map(
      store.state.hotkeySettings.map((obj) => [obj.action, obj.combination])
    )
);
// FIXME: string型は受け付けないべき
const getMenuBarHotkey = (label: HotkeyAction | string) => {
  const hotkey = hotkeySettingsMap.value.get(label);
  if (hotkey === undefined) {
    return "";
  } else {
    // Mac の Meta キーは Cmd キーであるため、Meta の表示名を Cmd に置換する
    // Windows PC では Meta キーは Windows キーだが、使用頻度低と考えられるため暫定的に Mac 対応のみを考慮している
    return hotkey.replaceAll(" ", "+").replaceAll("Meta", "Cmd");
  }
};
const uiLocked = computed(() => store.getters.UI_LOCKED);
const selectedComputed = computed({
  get: () => props.selected,
  set: (val) => emit("update:selected", val),
});
const subMenuOpenFlags = ref(
  props.menudata.type === "root"
    ? [...Array(props.menudata.subMenu.length)].map(() => false)
    : []
);
const reassignSubMenuOpen = (i: number) => {
  if (subMenuOpenFlags.value[i]) return;
  if (props.menudata.type !== "root") return;
  const len = props.menudata.subMenu.length;
  const arr = [...Array(len)].map(() => false);
  arr[i] = true;
  subMenuOpenFlags.value = arr;
};

if (props.menudata.type === "root") {
  watch(
    () => props.selected,
    () => {
      // 何もしないと自分の選択状態が変わっても子の選択状態は変わらないため、
      // 選択状態でなくなった時に子の選択状態をリセットします
      if (props.menudata.type === "root" && !props.selected) {
        const len = props.menudata.subMenu.length;
        subMenuOpenFlags.value = [...Array(len)].map(() => false);
      }
    }
  );
}
</script>

<style lang="scss" scoped>
.engine-icon {
  width: 24px;
  height: 24px;
  border-radius: 2px;
}
</style>
